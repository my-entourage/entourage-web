# Implementation Plan: Clerk Auth, Supabase Waitlist, and Resend Email

**Date**: 2025-12-27
**Based on**: `thoughts/shared/research/2025-12-27-clerk-supabase-resend-integration.md`

## Overview

Add authentication, waitlist functionality, and email notifications to the Entourage landing page:
1. **Clerk**: Authentication provider with branded sign-in/up pages and protected dashboard
2. **Supabase**: Database for storing waitlist signups
3. **Resend**: Email notifications to `iivo.angerpuro@gmail.com` on new signups
4. **ShadCN**: Form components with branded wrappers

---

## Phase 1: Install Dependencies and Environment Setup

### Changes
- [x] Install Clerk: `pnpm add @clerk/nextjs`
- [x] Install Supabase: `pnpm add @supabase/supabase-js @supabase/ssr`
- [x] Install Resend: `pnpm add resend`
- [x] Install ShadCN form components: `pnpm dlx shadcn@canary add input label`
- [x] Create `.env.example` with required environment variables
- [x] Update `.gitignore` to exclude `.env.local`

### Success Criteria
- All packages installed without errors
- `.env.example` documents all required variables
- `pnpm build` still works (no breaking changes yet)

---

## Phase 2: Clerk Authentication Setup

### Changes
- [x] Create `src/proxy.ts` with clerkMiddleware (Next.js 16 uses proxy.ts, not middleware.ts)
- [x] Update `src/app/layout.tsx` to wrap with ClerkProvider
- [x] Update `src/app/globals.css` to add clerk CSS layer for Tailwind v4
- [x] Create `src/app/sign-in/[[...sign-in]]/page.tsx`
- [x] Create `src/app/sign-up/[[...sign-up]]/page.tsx`
- [x] Create `src/app/dashboard/page.tsx` (protected, empty placeholder)

### Success Criteria
- App builds without errors
- `/sign-in` and `/sign-up` routes exist (will show Clerk error without API keys)
- `/dashboard` redirects to sign-in when not authenticated

### Manual Verification
- [ ] With valid Clerk keys: sign-in page displays with brand styling
- [ ] Sign-up page displays with brand styling
- [ ] Dashboard is protected and redirects unauthenticated users

---

## Phase 3: Update Header with Clerk Components

### Changes
- [x] Update `src/components/layout/header/Header.tsx`:
  - Import Clerk components (SignedIn, SignedOut, SignInButton, UserButton)
  - Replace Link-based login button with SignInButton
  - Show UserButton when signed in

### Success Criteria
- Header shows Login button when signed out
- Header shows user avatar when signed in
- Build passes

### Manual Verification
- [ ] Login button opens Clerk modal
- [ ] After sign-in, user button appears in header
- [ ] Sign out works and returns to homepage

---

## Phase 4: Supabase Client Setup

### Changes
- [x] Create `src/lib/supabase/client.ts` (browser client)
- [x] Create `src/lib/supabase/server.ts` (server client)

### Success Criteria
- Files created with correct imports
- Build passes
- TypeScript types resolve correctly

### Manual Verification
- [ ] With valid Supabase keys: can connect to database (will test in Phase 5)

---

## Phase 5: ShadCN Form Wrappers

### Changes
- [x] Create `src/components/Input.tsx` (branded wrapper for ui/input)
- [x] Create `src/components/Label.tsx` (branded wrapper for ui/label)

### Success Criteria
- Wrappers follow existing pattern (like Accordion.tsx)
- All styling uses rounded-none, dark mode variants
- Build passes

---

## Phase 6: Waitlist API Route with Resend

### Changes
- [x] Create `src/app/api/waitlist/route.ts`:
  - Accept POST with email and optional name
  - Save to Supabase waitlist table
  - Send notification email via Resend (lazy initialization)
  - Handle duplicate emails gracefully

### Success Criteria
- API route exists at `/api/waitlist`
- Build passes
- Returns proper JSON responses

### Manual Verification
- [ ] POST to `/api/waitlist` with valid email succeeds
- [ ] Duplicate email returns friendly message
- [ ] Email notification sent to owner (with valid Resend key)
- [ ] Record appears in Supabase waitlist table

---

## Phase 7: Waitlist Form Component

### Changes
- [x] Create `src/components/WaitlistForm.tsx`:
  - Email input (required)
  - Name input (optional)
  - Submit button with loading state
  - Success/error message display

### Success Criteria
- Component renders without errors
- Form validation works (email required)
- Loading state during submission
- Build passes

### Manual Verification
- [ ] Form submits successfully
- [ ] Loading state shows during submission
- [ ] Success message appears after submission
- [ ] Error message appears on failure

---

## Database Setup (Manual - Supabase Dashboard)

Run in Supabase SQL Editor:

```sql
-- Create waitlist table
CREATE TABLE public.waitlist (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email text NOT NULL UNIQUE,
  name text,
  created_at timestamptz DEFAULT now()
);

-- Enable Row Level Security
ALTER TABLE public.waitlist ENABLE ROW LEVEL SECURITY;

-- Allow anonymous inserts (for public waitlist)
CREATE POLICY "Allow anonymous inserts" ON public.waitlist
  FOR INSERT
  WITH CHECK (true);
```

---

## Environment Variables Required

```env
# Clerk (get from clerk.com dashboard)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_SIGN_IN_FORCE_REDIRECT_URL=/dashboard
NEXT_PUBLIC_CLERK_SIGN_UP_FORCE_REDIRECT_URL=/dashboard

# Supabase (get from supabase.com project settings)
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Resend (get from resend.com dashboard)
RESEND_API_KEY=re_...
```
