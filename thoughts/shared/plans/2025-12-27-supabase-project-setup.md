# Supabase Project Setup and Waitlist Verification

## Overview

Create a Supabase project within the existing "my-entourage" organization, set up the waitlist table with proper schema and RLS policies, configure environment variables, and verify the complete waitlist flow end-to-end.

## Current State Analysis

| Component | Status | Location |
|-----------|--------|----------|
| Supabase organization | Exists | "my-entourage" (id: budmaikihtuprfiuebkr) |
| Supabase project | **Missing** | Needs to be created |
| Client factories | Implemented | `src/lib/supabase/client.ts`, `server.ts` |
| Waitlist API route | Implemented | `src/app/api/waitlist/route.ts` |
| WaitlistForm component | Implemented | `src/components/WaitlistForm.tsx` |
| Waitlist page | Implemented | `src/app/waitlist/page.tsx` |
| Environment variables | Template only | `.env.example` has placeholders |

### Key Discovery

The WaitlistForm sends 3 fields: `email`, `name`, `company`. The database schema must include all three.

## Desired End State

1. Supabase project "entourage-web" running in "my-entourage" organization
2. `waitlist` table with columns: `id`, `email` (unique), `name`, `company`, `created_at`
3. RLS policy allowing anonymous inserts
4. `.env` configured with valid Supabase credentials
5. Complete flow verified: Form → API → Database → Email notification

### Verification Checklist

- [ ] `/waitlist` page loads correctly
- [ ] Form submission saves record to Supabase
- [ ] Duplicate email shows friendly "already on waitlist" message
- [ ] Success redirects to home with `?waitlist=success`
- [ ] Record visible in Supabase dashboard

## What We're NOT Doing

- Not setting up Supabase Auth (using Clerk instead)
- Not configuring Supabase Realtime
- Not generating TypeScript types from Supabase
- Not setting up Supabase Storage

---

## Phase 1: Create Supabase Project

### Overview

Create a new Supabase project in the "my-entourage" organization.

### Details

- **Organization**: my-entourage (id: `budmaikihtuprfiuebkr`)
- **Project name**: entourage-web
- **Region**: us-east-1 (or closest to your users)
- **Cost**: $0/month (free tier)

### Actions

1. Confirm cost understanding ($0/month)
2. Create project via Supabase MCP
3. Wait for project to initialize (can take 1-2 minutes)

### Success Criteria

#### Automated Verification:
- [x] `get_project` returns status "ACTIVE_HEALTHY"

#### Manual Verification:
- [ ] Project visible in Supabase dashboard at supabase.com

---

## Phase 2: Create Waitlist Table

### Overview

Apply a migration to create the `waitlist` table with the correct schema matching the WaitlistForm fields.

### Schema

```sql
CREATE TABLE public.waitlist (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email text NOT NULL,
  name text,
  company text,
  created_at timestamptz DEFAULT now(),
  CONSTRAINT waitlist_email_unique UNIQUE (email)
);

COMMENT ON TABLE public.waitlist IS 'Stores early access waitlist signups';
COMMENT ON COLUMN public.waitlist.email IS 'User email address (required, unique)';
COMMENT ON COLUMN public.waitlist.name IS 'User name (optional)';
COMMENT ON COLUMN public.waitlist.company IS 'User company (optional)';
```

### Actions

1. Apply migration via Supabase MCP `apply_migration`

### Success Criteria

#### Automated Verification:
- [x] `list_tables` shows `waitlist` table in public schema
- [x] Table has columns: id, email, name, company, created_at

---

## Phase 3: Configure RLS Policies

### Overview

Enable Row Level Security and create a policy allowing anonymous inserts (required for public waitlist form).

### Policies

```sql
-- Enable RLS
ALTER TABLE public.waitlist ENABLE ROW LEVEL SECURITY;

-- Allow anonymous inserts (for public waitlist form)
CREATE POLICY "Allow anonymous inserts" ON public.waitlist
  FOR INSERT
  TO anon
  WITH CHECK (true);

-- Prevent anonymous reads (protect user data)
-- No SELECT policy = no reads allowed for anon
```

### Actions

1. Apply RLS migration via Supabase MCP

### Success Criteria

#### Automated Verification:
- [x] `get_advisors` security check passes (RLS enabled)
- [x] Test INSERT via API works

---

## Phase 4: Update Environment Variables

### Overview

Get the Supabase project URL and anon key, then update the local `.env` file.

### Required Variables

```env
NEXT_PUBLIC_SUPABASE_URL=https://<project-ref>.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=<anon-key>
```

### Actions

1. Get project URL via `get_project_url`
2. Get anon key via `get_publishable_keys`
3. Create/update `.env` file with credentials

### Success Criteria

#### Automated Verification:
- [x] `.env` file exists with both Supabase variables
- [x] `pnpm build` passes (env vars accessible)

#### Manual Verification:
- [ ] Variables match Supabase dashboard values

---

## Phase 5: End-to-End Verification

### Overview

Test the complete waitlist flow from form submission to database record.

### Test Cases

#### Test 1: Successful Signup
1. Start dev server: `pnpm dev`
2. Navigate to `http://localhost:3000/waitlist`
3. Fill form: email="test@example.com", name="Test User", company="Test Co"
4. Submit form
5. Verify:
   - Success message appears
   - Redirects to `/?waitlist=success`
   - Record appears in Supabase dashboard

#### Test 2: Duplicate Email
1. Navigate to `/waitlist`
2. Submit same email again
3. Verify: "You are already on the waitlist!" message (200 response)

#### Test 3: Invalid Email
1. Submit with invalid email format
2. Verify: "Invalid email format" error (400 response)

#### Test 4: Missing Email
1. Submit with empty email
2. Verify: HTML5 validation prevents submission (required field)

### Success Criteria

#### Automated Verification:
- [x] Dev server starts: `pnpm dev`
- [x] Build passes: `pnpm build`

#### Manual Verification:
- [ ] Test 1 passes (successful signup)
- [ ] Test 2 passes (duplicate handling)
- [ ] Test 3 passes (validation)
- [ ] Record visible in Supabase Table Editor

**Implementation Note**: After completing all phases and automated verification passes, run through the manual test cases to confirm the complete flow works.

---

## Rollback Plan

If issues occur:
1. Delete the Supabase project via dashboard (irreversible)
2. Remove credentials from `.env`
3. The codebase remains unchanged (no code modifications in this plan)

---

## References

- Research document: `thoughts/shared/research/2025-12-27-supabase-connections.md`
- Original integration plan: `thoughts/shared/plans/2025-12-27-clerk-supabase-resend-integration.md`
- API route: `src/app/api/waitlist/route.ts`
- Form component: `src/components/WaitlistForm.tsx`
